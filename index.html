<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>かろearthガチャ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap');
  body {
    margin: 0; background: #f5f7fa; font-family: 'Kosugi Maru', sans-serif; color: #333;
    display: flex; flex-direction: column; align-items: center; min-height: 100vh;
  }
  header {
    background: #4a90e2; color: white; width: 100%; padding: 1.2em 0; text-align: center;
    font-size: 1.8em; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  main {
    max-width: 480px; width: 90%; margin: 1em auto; background: white; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 1.5em;
  }
  button#drawBtn {
    background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
    border: none; border-radius: 8px; font-size: 1.4em; font-weight: 700; padding: 12px 0;
    width: 100%; color: #5b1a18; cursor: pointer; box-shadow: 0 5px 15px rgba(255,154,158,0.5);
    transition: transform 0.2s ease;
  }
  button#drawBtn:active {
    transform: scale(0.95);
  }
  #resultArea {
    margin-top: 1.2em; font-size: 1.6em; font-weight: 700; text-align: center;
    min-height: 48px; color: #de4c4a;
    user-select: none;
  }
  #itemsList, #historyList {
    margin-top: 1em; max-height: 180px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 1em;
  }
  .sectionTitle {
    font-weight: 700; margin-bottom: 0.5em; font-size: 1.2em; color: #444;
  }
  .itemCard {
    display: flex; justify-content: space-between; align-items: center;
    background: #fff3f3; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(222, 76, 74, 0.3);
  }
  .itemName {
    font-weight: 700; 
  }
  .itemCount {
    background: #b23a38; color: white; border-radius: 9999px; padding: 0 12px; font-weight: 700;
  }
  .historyEntry {
    font-size: 0.9em; padding: 6px 8px; border-bottom: 1px solid #eee;
    color: #666;
  }
  .historyEntry:last-child {
    border-bottom: none;
  }
  footer {
    margin-top: auto; padding: 1em 0; font-size: 0.9em; color: #999;
    user-select: none;
  }
</style>
</head>
<body>

<header>かろearthガチャ 🎲</header>

<main>
  <button id="drawBtn">ガチャを引く</button>
  <div id="resultArea">ここに結果が表示されます</div>

  <section>
    <h2 class="sectionTitle">所持アイテム一覧</h2>
    <div id="itemsList"><i>まだ何も持っていません。</i></div>
  </section>

  <section>
    <h2 class="sectionTitle">ガチャ履歴</h2>
    <div id="historyList"><i>まだ履歴がありません。</i></div>
  </section>
</main>

<footer>©かろearthガチャ</footer>

<script>
// ====== 初期データ ======
const items = [
  { id: "item001", name: "いか", rarity: "N" },
  { id: "item002", name: "神聖ローマ帝国", rarity: "N" },
  { id: "item100", name: "りく", rarity: "R" },
  { id: "item101", name: "code", rarity: "N" },
  { id: "item102", name: "ssk", rarity: "N" },
  { id: "item003", name: "ドイツ帝国", rarity: "R" },
  { id: "item103", name: "プロイセン王国", rarity: "R" },
  { id: "item104", name: "アイスランド", rarity: "R+" },
  { id: "item105", name: "こあです", rarity: "R++" },
  { id: "item004", name: "めだか", rarity: "SR" },
  { id: "item106", name: "もみじ", rarity: "SR+" },
  { id: "item005", name: "ららぁ", rarity: "SSR" },
  { id: "item107", name: "親子丼", rarity: "SSR+" },
  { id: "item006", name: "大日本帝国", rarity: "UR" },
  { id: "item028", name: "雷", rarity: "MR" },
  { id: "item030", name: "こはとく", rarity: "LR" },
  { id: "item060", name: "しろこ", rarity: "ER" },
  { id: "item200", name: "かろん", rarity: "GR" }
];

const rarityColors = {
  GR: "#ffd700", ER: "#ffa500", LR: "#ff8000", MR: "#b366ff", UR: "#db2777",
  SSR: "#ef4444", "SSR+": "#f87171", SR: "#facc15", "SR+": "#fcd34d",
  R: "#3b82f6", "R+": "#60a5fa", "R++": "#93c5fd", N: "#a0a0a0"
};

const rarityRates = {
  GR: 0.05, ER: 0.1, LR: 0.15, MR: 0.2, UR: 0.3,
  SSR: 1, "SSR+": 1.5, SR: 3, "SR+": 3,
  R: 8, "R+": 10, "R++": 8, N: 50.2
};

// ====== データ読み込み（localStorage） ======
const ownedItems = JSON.parse(localStorage.getItem("ownedItems") || "{}");
const history = JSON.parse(localStorage.getItem("history") || "[]");

// ====== DOM ======
const drawBtn = document.getElementById("drawBtn");
const resultArea = document.getElementById("resultArea");
const itemsList = document.getElementById("itemsList");
const historyList = document.getElementById("historyList");

// ====== 所持アイテム表示（レア度順） ======
function updateOwnedList() {
  itemsList.innerHTML = "";
  if (Object.keys(ownedItems).length === 0) {
    itemsList.innerHTML = "<i>まだ何も持っていません。</i>";
    return;
  }

  const rarityOrder = ["GR", "ER", "LR", "MR", "UR", "SSR", "SSR+", "SR", "SR+", "R", "R+", "R++", "N"];

  const sorted = Object.entries(ownedItems).sort((a, b) => {
    const itemA = items.find(i => i.id === a[0]);
    const itemB = items.find(i => i.id === b[0]);
    const rA = rarityOrder.indexOf(itemA.rarity);
    const rB = rarityOrder.indexOf(itemB.rarity);
    if (rA !== rB) return rA - rB;
    return itemA.name.localeCompare(itemB.name);
  });

  for (const [id, count] of sorted) {
    const item = items.find(i => i.id === id);
    const card = document.createElement("div");
    card.className = "itemCard";
    card.style.border = `2px solid ${rarityColors[item.rarity]}`;
    card.innerHTML = `
      <span class="itemName" style="color:${rarityColors[item.rarity]}">${item.name}</span>
      <span class="itemCount">×${count}</span>
    `;
    itemsList.appendChild(card);
  }
}

// ====== ガチャ履歴表示 ======
function updateHistory() {
  historyList.innerHTML = "";
  if (history.length === 0) {
    historyList.innerHTML = "<i>まだ履歴がありません。</i>";
    return;
  }
  history.slice().reverse().forEach(entry => {
    const div = document.createElement("div");
    div.className = "historyEntry";
    div.textContent = `${entry.date} - ${entry.name}`;
    historyList.appendChild(div);
  });
}

// ====== 結果演出 ======
function animateResult(text, color) {
  resultArea.style.color = color;
  resultArea.textContent = "";
  let i = 0;
  const interval = setInterval(() => {
    resultArea.textContent += text[i++];
    if (i >= text.length) clearInterval(interval);
  }, 60);
}

// ====== ガチャ処理 ======
function getRandomRarity() {
  const rand = Math.random() * 100;
  let sum = 0;
  for (const [rarity, rate] of Object.entries(rarityRates)) {
    sum += rate;
    if (rand < sum) return rarity;
  }
  return "N";
}

function getRandomItem() {
  const rarity = getRandomRarity();
  const pool = items.filter(i => i.rarity === rarity);
  return pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : items[0];
}

drawBtn.addEventListener("click", () => {
  drawBtn.disabled = true;
  const item = getRandomItem();
  ownedItems[item.id] = (ownedItems[item.id] || 0) + 1;
  const now = new Date();
  const dateStr = now.toLocaleString("ja-JP", { hour12: false });
  history.push({ name: item.name, date: dateStr });

  // セーブ
  localStorage.setItem("ownedItems", JSON.stringify(ownedItems));
  localStorage.setItem("history", JSON.stringify(history));

  animateResult(`🌏 ${item.name} をゲット！`, rarityColors[item.rarity]);
  updateOwnedList();
  updateHistory();

  setTimeout(() => drawBtn.disabled = false, 1500);
});

// 初期表示
updateOwnedList();
updateHistory();
</script>

</body>
</html>